# Java内存区域

1.  运行时数据区域

    java虚拟机在执行java程序的过程中会把它管理的内存划分为若干个不通的数据区域。

    <img src="imags/%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F.png" alt="image-20210823153329208" data-size="original">
2. 程序计数器
   * 程序计数器是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。在虚拟机的概念模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。
   * 由于java虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现的（处理器分片概念）。在任何一个确定的时刻，一个处理器都只会执行一个独立的程序计数器。所以每个不同的线程会有自己独立的程序计数器，相互不影响，独立存储。我们称此内存区域为：线程私有的内存
   * 唯一一个在java虚拟机规范中没有规定任何oom情况的区域。生命周期与线程相同
3. java虚拟机栈
   * 与程序计数器一样，java虚拟机栈也是线程私有的，它的生命周期与线程相同。
   *   虚拟机栈描述的是java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧用于存储局部变量、操作数栈、动态链接、方法出口等信息。

       <img src="C:%5CUsers%5Cqhyu%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200527153230088.png" alt="image-20200527153230088" data-size="original">
   * 局部变量表存放了编译器可知的各种基本数据类型(boolean、byte、char、short、int、float、long、double)、对象引用和返回类型。
   * 其中long和double类型的数据会占用2个局部变量空间(局部变量空间以变量槽来表示Slot)。其余的类型只占1个。局部变量表所需要的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改边局部变量表的大小。（这里说的大小是指slot的数量）
   * 在java虚拟机规范中，对这个区域规定了两种异常状况：如果线程请求的栈深度大于当前虚拟机所允许的深度，将抛出StackOverflowError异常。虚拟机栈可动态扩展的情况时无法申请到足够的内存，就会抛出OOM异常（HotSpot虚拟机的栈容量是不可动态扩展的，只要线程申请栈空间成功了就不会有OOM）。
4. 本地方法栈
   * 本地方法栈与虚拟机栈发挥的作用是非常相似的，区别是java虚拟机栈执行java方法服务，而本地方法栈使用到的是native方法服务。
   * 与java虚拟机栈一样，本地方法栈区域也会抛出StackOverflowError 和OOM异常。
5. java堆
   * java堆内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。
   * java虚拟机规范中的描述是:所有的对象实例以及数组都要在堆上分配，但是随着即时编译器(JIT)的发展与逃逸分析技术逐渐成熟，栈上分配、标量替换技术将会导致一些微妙的变化发生，所以所有的对象都分配在堆上也渐渐变得没有那么绝对了。
   * java堆是垃圾回收器管理的主要区域，也称为GC堆。从内存回收的角度来看，由于现在收集器基本都采用分代收集算法，所以java堆中还可以细分为新生代和老年代、再细致一点的有eden空间、from survivor空间、to survivor空间等。
   * Java堆既可以被实现成固定大小的，也可以是扩展的，不过当前的Java虚拟机都是按照可扩展实现的(-Xms -Xmx)
   * 如果在堆中没有内存完成实例分配，并且堆也无法扩展时将会OOM异常
   * 此区域是线程共享区域
6. 方法区
   * 方法区与java堆一样，是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。也叫non-heap(非堆)，目的是和java堆区分开。
   * java1.7之后将字符串常量池、静态变量等移出了永久代，java1.7之前永久代即现在的方法区。
   * 根据java虚拟机规范规定，当方法区无法满足内存分配的需求时OOM异常
7. 运行时常量池
   * 运行时常量池是方法区的一部分。class文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池表，用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放。
   * 既然运行时常量池是方法区的一部分，即处于内存共享区域。当常量池无法再申请到内存时OOM异常
   * 并非预置入Class文件中常量池的内容才能进入方法区运行时常量池。intern()方法用的较多。
